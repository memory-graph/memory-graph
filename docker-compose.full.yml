version: '3.8'

services:
  memgraph:
    image: memgraph/memgraph-platform
    container_name: memorygraph-memgraph
    ports:
      - "7687:7687"  # Bolt protocol
      - "3000:3000"  # Memgraph Lab
    environment:
      - MEMGRAPH_MEM_LIMIT=4096
    volumes:
      - memgraph_data:/var/lib/memgraph
      - memgraph_log:/var/log/memgraph
    healthcheck:
      test: ["CMD-SHELL", "mgconsole --host memgraph --port 7687 --use-ssl=False --query 'RETURN 1;' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  memorygraph:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: memorygraph-server
    depends_on:
      memgraph:
        condition: service_healthy
    stdin_open: true  # Required for MCP stdio
    tty: true         # Required for MCP stdio
    environment:
      - MEMORY_BACKEND=memgraph
      - MEMORY_TOOL_PROFILE=extended
      - MEMORY_MEMGRAPH_URI=bolt://memgraph:7687
      - MEMORY_LOG_LEVEL=INFO
    restart: unless-stopped

volumes:
  memgraph_data:
    driver: local
  memgraph_log:
    driver: local
